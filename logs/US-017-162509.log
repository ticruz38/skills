â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ # Ralph Agent Instructions                                                   â”‚
â”‚                                                                              â”‚
â”‚ You are an autonomous coding agent working on a software project.            â”‚
â”‚                                                                              â”‚
â”‚ ## ğŸ›¡ï¸ CRITICAL SAFETY RULES - NEVER VIOLATE                                   â”‚
â”‚                                                                              â”‚
â”‚ ### System Resource Protection                                               â”‚
â”‚ The following actions are **STRICTLY PROHIBITED** and will cause harm to the â”‚
â”‚ host system:                                                                 â”‚
â”‚                                                                              â”‚
â”‚ **Docker/Container Management:**                                             â”‚
â”‚ - **NEVER** run `docker stop` without an explicit container name or ID       â”‚
â”‚ - **NEVER** use `docker stop $(docker ps -q)` or any pattern that stops mult â”‚
â”‚ iple/all containers                                                          â”‚
â”‚ - **NEVER** run `docker rm -f $(docker ps -aq)` or similar mass-removal comm â”‚
â”‚ ands                                                                         â”‚
â”‚ - **ALWAYS** verify container names with `docker ps --filter name=<pattern>` â”‚
â”‚ before stopping                                                              â”‚
â”‚ - **ONLY** stop containers that were explicitly created by this session      â”‚
â”‚ - **ONLY** stop containers using their explicit name: `docker stop <exact-co â”‚
â”‚ ntainer-name>`                                                               â”‚
â”‚                                                                              â”‚
â”‚ **Process Management:**                                                      â”‚
â”‚ - **NEVER** run `killall`, `pkill`, or similar commands without specific pro â”‚
â”‚ cess names                                                                   â”‚
â”‚ - **NEVER** use `kill -9` on system processes or processes you didn't start  â”‚
â”‚ - **ONLY** terminate processes you explicitly started in this session        â”‚
â”‚                                                                              â”‚
â”‚ **Port/Network Conflicts:**                                                  â”‚
â”‚ - If a port is in use, **USE A DIFFERENT PORT** instead of killing the proce â”‚
â”‚ ss using it                                                                  â”‚
â”‚ - Check what's running on a port with `lsof -i :<port>` or `ss -tlnp | grep  â”‚
â”‚ <port>`                                                                      â”‚
â”‚ - Prefer random/high ports (e.g., `docker run -p 0:8080`) to avoid conflicts â”‚
â”‚                                                                              â”‚
â”‚ **General Safety:**                                                          â”‚
â”‚ - **NEVER** run commands that affect system-wide state unless explicitly req â”‚
â”‚ uired by the PRD                                                             â”‚
â”‚ - **NEVER** use wildcards or glob patterns with destructive commands (`rm`,  â”‚
â”‚ `kill`, `stop`)                                                              â”‚
â”‚ - When in doubt, be explicit and specific with resource names                â”‚
â”‚                                                                              â”‚
â”‚ ---                                                                          â”‚
â”‚                                                                              â”‚
â”‚ ## Your Task                                                                 â”‚
â”‚                                                                              â”‚
â”‚ 1. Read the PRD at `prd.json` (in the same directory as this file)           â”‚
â”‚ 2. Read the progress log at `progress.txt` (check Codebase Patterns section  â”‚
â”‚ first)                                                                       â”‚
â”‚ 3. Check you're on the correct branch from PRD `branchName`. If not, check i â”‚
â”‚ t out or create from main.                                                   â”‚
â”‚ 4. Pick the **highest priority** user story where `passes: false`            â”‚
â”‚ 5. Implement that single user story                                          â”‚
â”‚ 6. Run quality checks (e.g., typecheck, lint, test - use whatever your proje â”‚
â”‚ ct requires)                                                                 â”‚
â”‚ 7. Update AGENTS.md files if you discover reusable patterns (see below)      â”‚
â”‚ 8. If checks pass, commit ALL changes with message: `feat: [Story ID] - [Sto â”‚
â”‚ ry Title]`                                                                   â”‚
â”‚ 9. Update the PRD to set `passes: true` for the completed story              â”‚
â”‚ 10. Append your progress to `progress.txt`                                   â”‚
â”‚                                                                              â”‚
â”‚ ## Progress Report Format                                                    â”‚
â”‚                                                                              â”‚
â”‚ APPEND to progress.txt (never replace, always append):                       â”‚
â”‚ ```                                                                          â”‚
â”‚ ## [Date/Time] - [Story ID]                                                  â”‚
â”‚ - What was implemented                                                       â”‚
â”‚ - Files changed                                                              â”‚
â”‚ - **Learnings for future iterations:**                                       â”‚
â”‚   - Patterns discovered (e.g., "this codebase uses X for Y")                 â”‚
â”‚   - Gotchas encountered (e.g., "don't forget to update Z when changing W")   â”‚
â”‚   - Useful context (e.g., "the evaluation panel is in component X")          â”‚
â”‚ ---                                                                          â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ The learnings section is critical - it helps future iterations avoid repeati â”‚
â”‚ ng mistakes and understand the codebase better.                              â”‚
â”‚                                                                              â”‚
â”‚ ## Consolidate Patterns                                                      â”‚
â”‚                                                                              â”‚
â”‚ If you discover a **reusable pattern** that future iterations should know, a â”‚
â”‚ dd it to the `## Codebase Patterns` section at the TOP of progress.txt (crea â”‚
â”‚ te it if it doesn't exist). This section should consolidate the most importa â”‚
â”‚ nt learnings:                                                                â”‚
â”‚                                                                              â”‚
â”‚ ```                                                                          â”‚
â”‚ ## Codebase Patterns                                                         â”‚
â”‚ - Example: Use `sql<number>` template for aggregations                       â”‚
â”‚ - Example: Always use `IF NOT EXISTS` for migrations                         â”‚
â”‚ - Example: Export types from actions.ts for UI components                    â”‚
â”‚ ```                                                                          â”‚
â”‚                                                                              â”‚
â”‚ Only add patterns that are **general and reusable**, not story-specific deta â”‚
â”‚ ils.                                                                         â”‚
â”‚                                                                              â”‚
â”‚ ## Update AGENTS.md Files                                                    â”‚
â”‚                                                                              â”‚
â”‚ Before committing, check if any edited files have learnings worth preserving â”‚
â”‚ in nearby AGENTS.md files:                                                   â”‚
â”‚                                                                              â”‚
â”‚ 1. **Identify directories with edited files** - Look at which directories yo â”‚
â”‚ u modified                                                                   â”‚
â”‚ 2. **Check for existing AGENTS.md** - Look for AGENTS.md in those directorie â”‚
â”‚ s or parent directories                                                      â”‚
â”‚ 3. **Add valuable learnings** - If you discovered something future developer â”‚
â”‚ s/agents should know:                                                        â”‚
â”‚    - API patterns or conventions specific to that module                     â”‚
â”‚    - Gotchas or non-obvious requirements                                     â”‚
â”‚    - Dependencies between files                                              â”‚
â”‚    - Testing approaches for that area                                        â”‚
â”‚    - Configuration or environment requirements                               â”‚
â”‚                                                                              â”‚
â”‚ **Examples of good AGENTS.md additions:**                                    â”‚
â”‚ - "When modifying X, also update Y to keep them in sync"                     â”‚
â”‚ - "This module uses pattern Z for all API calls"                             â”‚
â”‚ - "Tests require the dev server running on PORT 3000"                        â”‚
â”‚ - "Field names must match the template exactly"                              â”‚
â”‚                                                                              â”‚
â”‚ **Do NOT add:**                                                              â”‚
â”‚ - Story-specific implementation details                                      â”‚
â”‚ - Temporary debugging notes                                                  â”‚
â”‚ - Information already in progress.txt                                        â”‚
â”‚                                                                              â”‚
â”‚ Only update AGENTS.md if you have **genuinely reusable knowledge** that woul â”‚
â”‚ d help future work in that directory.                                        â”‚
â”‚                                                                              â”‚
â”‚ ## Quality Requirements                                                      â”‚
â”‚                                                                              â”‚
â”‚ - ALL commits must pass your project's quality checks (typecheck, lint, test â”‚
â”‚ )                                                                            â”‚
â”‚ - Do NOT commit broken code                                                  â”‚
â”‚ - Keep changes focused and minimal                                           â”‚
â”‚ - Follow existing code patterns                                              â”‚
â”‚                                                                              â”‚
â”‚ ## Browser Testing (Required for Frontend Stories)                           â”‚
â”‚                                                                              â”‚
â”‚ For any story that changes UI, you MUST verify it works in the browser:      â”‚
â”‚                                                                              â”‚
â”‚ 1. Load the `dev-browser` skill                                              â”‚
â”‚ 2. Navigate to the relevant page                                             â”‚
â”‚ 3. Verify the UI changes work as expected                                    â”‚
â”‚ 4. Take a screenshot if helpful for the progress log                         â”‚
â”‚                                                                              â”‚
â”‚ A frontend story is NOT complete until browser verification passes.          â”‚
â”‚                                                                              â”‚
â”‚ ## Stop Condition                                                            â”‚
â”‚                                                                              â”‚
â”‚ After completing a user story, check if ALL stories have `passes: true`.     â”‚
â”‚                                                                              â”‚
â”‚ If ALL stories are complete and passing, reply with:                         â”‚
â”‚ <promise>COMPLETE</promise>                                                  â”‚
â”‚                                                                              â”‚
â”‚ If there are still stories with `passes: false`, end your response normally  â”‚
â”‚ (another iteration will pick up the next story).                             â”‚
â”‚                                                                              â”‚
â”‚ ## Important                                                                 â”‚
â”‚                                                                              â”‚
â”‚ - Work on ONE story per iteration                                            â”‚
â”‚ - Commit frequently                                                          â”‚
â”‚ - Keep CI green                                                              â”‚
â”‚ - Read the Codebase Patterns section in progress.txt before starting         â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â€¢ Let me start by reading the PRD file and the progress log to understand what n
  eeds to be done.
â€¢ Used ReadFile (prd.json)
â€¢ Used ReadFile (progress.txt)
â€¢ Now I have a clear picture. The PRD has 60 user stories, and US-001 through US
  -016 are already marked as passing ("passes": true). The next highest priority
  story that needs implementation is US-017: Create receipts-ocr skill for expen
  se scanning.

  Let me examine the requirements for this story:

  â€¢ Title: Create receipts-ocr skill for expense scanning
  â€¢ Description: Extract data from receipt photos using Google Vision
  â€¢ Acceptance Criteria:
    1. Upload receipt images
    2. OCR merchant, amount, date
    3. Line item extraction
    4. Confidence scoring
    5. Manual correction UI
    6. Store in SQLite
    7. Typecheck passes
  â€¢ Priority: 17
  â€¢ Notes: Depends: google-oauth (Vision API)

  From the progress.txt, I can see the patterns used:

  â€¢ TypeScript with src/ directory structure
  â€¢ sqlite3 for database
  â€¢ File-based dependencies with "@openclaw/auth-provider": "file:../auth-provid
    "
  â€¢ Using import * as sqlite3 from 'sqlite3' pattern
  â€¢ Dynamic imports for ES modules

  Let me check what the current skills directory looks like and the structure of
  existing skills:
â€¢ Let me check the current branch and explore the skills directory structure:
â€¢ Used Shell (cd /root/code/skills && g...current && ls -la skills/)
â€¢ Used Glob (skills/*/SKILL.md)
â€¢ I'm on the correct branch ralph/all-skills. Now let me look at the structure o
  f a skill that depends on google-oauth and uses image processing. Let me check
  the invoices skill as a reference since it was just created and may have simil
  ar patterns. I should also look at how the google-oauth skill is structured fo
  r using Google APIs.
â€¢ Let me check the structure of a skill that uses Google OAuth and the google-oa
  uth skill itself to understand how to use the Vision API:
â€¢ Used ReadFile (skills/invoices/src/index.ts)
â€¢ Used ReadFile (skills/invoices/package.json)
â€¢ Used ReadFile (skills/google-oauth/src/index.ts)
â€¢ Now I have a good understanding of the skill structure. Let me also check how
  the email skill handles authentication with Google OAuth to see the pattern fo
  r using the fetch method:
â€¢ Let me also check the email skill to see how it uses Google OAuth for API call
  s:
â€¢ Used ReadFile (skills/email/src/index.ts)
â€¢ Now I have a good understanding of the patterns. Let me create the receipts-oc
  r skill. This skill needs to:

  1. Use Google OAuth (Vision API) to OCR receipt images
  2. Extract merchant, amount, date from receipts
  3. Extract line items
  4. Provide confidence scoring
  5. Allow manual correction
  6. Store in SQLite

  Let me create the skill directory structure and files:
â€¢ Now I have a clear picture of the patterns. Let me create the receipts-ocr ski
  ll. First, let me set up the directory structure and files:
â€¢ Used Shell (mkdir -p skills/receipts-ocr/src)
â€¢ Now I'll create all the necessary files for the receipts-ocr skill:

  1. package.json - Dependencies
  2. tsconfig.json - TypeScript configuration
  3. .gitignore - Ignore node_modules and dist
  4. SKILL.md - Documentation
  5. src/index.ts - Main library with ReceiptsOCRSkill class
  6. src/cli.ts - CLI interface

  Let me create these files.
â€¢ Used WriteFile (skills/receipts-ocr/package.json)
â€¢ Used WriteFile (skills/receipts-ocr/tsconfig.json)
â€¢ Used WriteFile (skills/receipts-ocr/.gitignore)
â€¢ Now let me create the main index.ts file with the ReceiptsOCRSkill class. This
  will be a comprehensive implementation with:

  1. Google Vision API integration for OCR
  2. Receipt data extraction (merchant, amount, date, line items)
  3. Confidence scoring
  4. SQLite storage for receipts and line items
  5. Manual correction support
  6. Image storage management
â€¢ Used WriteFile (skills/receipts-ocr/src/index.ts)
â€¢ Now let me create the CLI file for the receipts-ocr skill:
â€¢ Now let me create the CLI:
â€¢ Used WriteFile (skills/receipts-ocr/src/cli.ts)
â€¢ Now let me create the SKILL.md documentation file:
â€¢ Now let me create the SKILL.md documentation:
â€¢ Used WriteFile (skills/receipts-ocr/SKILL.md)
â€¢ Now let me install dependencies and run the typecheck:
â€¢ Now let's install dependencies and run the typecheck:
â€¢ Used Shell (cd /root/code/skills/skil...s-ocr && npm install 2>&1)
â€¢ Dependencies installed. Now let's run the typecheck:
â€¢ Used Shell (cd /root/code/skills/skil...&& npm run typecheck 2>&1)
  Failed with exit code: 2
â€¢ There's a type error in the exportToCSV method. The status option is being pas
  sed as string instead of the specific union type. Let me fix that:
â€¢ Let me fix the type error:
â€¢ Used ReadFile (skills/receipts-ocr/src/index.ts)
â€¢ The issue is that exportToCSV uses status?: string but listReceipts expects st
  atus?: 'pending' | 'confirmed' | 'corrected' | 'rejected'. I need to cast the
  type or use the proper union type. Let me fix this:
â€¢ Used StrReplaceFile (skills/receipts-ocr/src/index.ts)
â€¢ Now let's run the typecheck again:
â€¢ Used Shell (cd /root/code/skills/skil...&& npm run typecheck 2>&1)
â€¢ Typecheck passes. Now let me build the project to ensure everything compiles c
  orrectly:
â€¢ Typecheck passes. Let's build to make sure everything compiles:
â€¢ Used Shell (cd /root/code/skills/skil...ocr && npm run build 2>&1)
â€¢ Build successful. Now let me verify the skill works correctly by checking the
  status command:
â€¢ Build successful. Let me verify the CLI works:
â€¢ Used Shell (cd /root/code/skills/skil...e dist/cli.js status 2>&1)
â€¢ The CLI works. Let me also verify the health check:
â€¢ Used Shell (cd /root/code/skills/skil...e dist/cli.js health 2>&1)
â€¢ The skill is working. Let me also check the help command:
â€¢ Used Shell (cd /root/code/skills/skil...ode dist/cli.js help 2>&1)
â€¢ Everything is working. Now let me commit the changes and update the progress l
  og:
â€¢ All working. Now let me commit the changes:
â€¢ Used Shell (cd /root/code/skills && git add -A && git status)
â€¢ Now let me commit the changes and update the PRD and progress.txt:
â€¢ Used Shell (cd /root/code/skills && g...ill for expense scanning")
â€¢ Now let me update the PRD to set passes: true for US-017:
â€¢ Now update the PRD to mark US-017 as passing:
â€¢ Used StrReplaceFile (prd.json)
â€¢ Now let me append the progress to progress.txt:
â€¢ Now append the progress to progress.txt:
â€¢ Used Shell (cat >> /root/code/skills/...r proper parsing --- EOF )
â€¢ Now let me verify that the changes are complete and the PRD is updated correct
  ly:
â€¢ Let me verify the changes are complete:
â€¢ Used Shell (cd /root/code/skills && g... diff prd.json | head -20)
â€¢ Used Shell (tail -50 /root/code/skills/progress.txt)
â€¢ Everything looks good. Let me commit the PRD and progress.txt changes:
â€¢ Let me commit the PRD and progress updates:
â€¢ Used Shell (cd /root/code/skills && g... status and progress log")
â€¢ Done! Let me provide a summary of what was completed.
â€¢ Summary

  I have successfully implemented US-017: Create receipts-ocr skill for expense
  scanning.

  What was implemented:

  1. ReceiptsOCRSkill class (src/index.ts):
    â€¢ Google Vision API integration for OCR using DOCUMENT_TEXT_DETECTION
    â€¢ Smart parsing to extract merchant, total amount, tax, date, payment method
    â€¢ Line item extraction with quantity, unit price, and totals
    â€¢ Confidence scoring for each field (0-100%)
    â€¢ Auto-categorization (Groceries, Dining, Gas, etc.)
    â€¢ SQLite storage with receipts and line_items tables
    â€¢ Manual correction support via update methods
    â€¢ Status workflow: pending â†’ confirmed/corrected/rejected
    â€¢ CSV export functionality
    â€¢ Statistics and reporting
  2. CLI interface (src/cli.ts):
    â€¢ status - Check connection status
    â€¢ health - Health check
    â€¢ scan <image> - Process and save receipt
    â€¢ text <image> - Extract text without saving
    â€¢ list - List receipts with filtering
    â€¢ get <id> - Get receipt details
    â€¢ update <id> - Manual correction of any field
    â€¢ confirm/reject <id> - Mark receipt status
    â€¢ delete <id> - Remove receipt
    â€¢ stats - Show statistics and breakdowns
    â€¢ export [path] - CSV export
  3. Typecheck passes âœ“
  4. Documentation (SKILL.md) with usage examples

  Commits:

  â€¢ feat: US-017 - Create receipts-ocr skill for expense scanning
  â€¢ docs: Update US-017 status and progress log

  There are still 43 stories remaining with passes: false. The next highest prio
  rity story is US-018: Create quickbooks skill for accounting sync.
